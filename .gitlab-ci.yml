stages:
  - build
  - deploy

# Variables para el runner
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://docker:2375 # Usa el puerto estándar sin TLS
  DOCKER_TLS_CERTDIR: ""          # Desactiva por completo TLS

# Etiqueta del runner
default:
  tags:
    - CesRunner

# Build stage
build:
  stage: build
  image: docker:20.10.16
  services:
    - docker:dind
  script:
    - docker info # Verificar que el daemon esté en funcionamiento
    - docker build -t myapp-image .
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 day

# Deploy stage
deploy:
  stage: deploy
  image: docker:20.10.16
  services:
    - docker:dind
  script:
    - docker run -d --name myapp -p 8080:8080 myapp-image
  only:
    - main
